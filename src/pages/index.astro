---
import Layout from '../layouts/Layout.astro';

const response = await fetch('https://oid.ioid.workers.dev/root.json');
const rootRegistries = await response.json();
---
<Layout title="IOID - OID Registry Dashboard">
  <header class="mb-12">
    <h1 class="text-4xl font-bold text-white">OID REGISTRY</h1>
    <p class="text-lg text-zinc-400 mt-2">
      Managed by the General Secretariat of the International Organization for Identity Document (IOID)
    </p>
  </header>
  <section id="registry" class="mt-12">
    <div class="rounded-lg overflow-hidden bg-black">
      <table class="w-full table-auto text-[12px] text-left">
        <thead class="text-md text-white uppercase bg-zinc-800 border-b border-zinc-600">
          <tr>
            <th class="px-6 py-4 font-semibold tracking-wider w-[25%]">Decimal</th>
            <th class="px-6 py-4 font-semibold tracking-wider w-[35%]">Organization / Authority</th>
            <th class="px-6 py-4 font-semibold tracking-wider w-[25%]">Registrar</th>
            <th class="px-6 py-4 font-semibold tracking-wider w-[15%]">Status</th>
          </tr>
        </thead>
        <tbody class="divide-y divide-zinc-800">
          {rootRegistries.map(root => (
            <>
              <tr class="bg-black">
                <td class="px-6 py-4 font-mono font-bold text-white">
                  <a href={`/registrar/oid/${root.oid}/`}>{root.oid}</a>
                </td>
                <td class="px-6 py-4 font-semibold text-white">{root.name}</td>
                <td class="px-6 py-4 text-white">{root.owner}</td>
                <td class="px-6 py-4">{root.status}</td>
              </tr>
              {root.subRegistries && root.subRegistries.map(sub => {
                const fullOid = `${root.oid}.${sub.oid}`;
                const isInternal = sub.internal === "true";
                return (
                  <>
                    <tr>
                      <td class="px-6 py-4 font-mono text-cyan-400 pl-10">
                        <span class="select-none mr-2 text-white">↳</span>
                        {isInternal ? (
                          <a href={`/registrar/oid/${fullOid}/`}>{fullOid}</a>
                        ) : (
                          <a href={sub.url} target="_blank" rel="noopener noreferrer" class="inline-flex items-center gap-2">
                            {fullOid}
                            <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="opacity-50"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path><polyline points="15 3 21 3 21 9"></polyline><line x1="10" y1="14" x2="21" y2="3"></line></svg>
                          </a>
                        )}
                      </td>
                      <td class="px-6 py-4 text-white">{sub.name}</td>
                      <td class="px-6 py-4 text-white">
                        {sub.owner}
                        {!isInternal && <div><span class="block text-xs text-white/65">External</span></div>}
                      </td>
                      <td class="px-6 py-4 text-left">{sub.status ?? 'ACTIVE'}</td>
                    </tr>
                    {isInternal && sub.subRegistries && sub.subRegistries.map(grandchild => {
                      const grandchildFullOid = `${fullOid}.${grandchild.oid}`;
                      const isGrandchildInternal = grandchild.internal === "true";
                      return (
                        <tr>
                          <td class="px-6 py-4 font-mono text-teal-400 pl-16">
                            <span class="select-none mr-2 text-white/50">↳</span>
                            {isGrandchildInternal ? (
                              <a href={`/registrar/oid/${grandchildFullOid}/`}>{grandchildFullOid}</a>
                            ) : (
                              <a href={grandchild.url} target="_blank" rel="noopener noreferrer" class="inline-flex items-center gap-2">
                                {grandchildFullOid}
                                <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="opacity-50"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path><polyline points="15 3 21 3 21 9"></polyline><line x1="10" y1="14" x2="21" y2="3"></line></svg>
                              </a>
                            )}
                          </td>
                          <td class="px-6 py-4 text-white/90">{grandchild.name}</td>
                          <td class="px-6 py-4 text-white/90">
                            {grandchild.owner}
                            {!isGrandchildInternal && <div><span class="block text-xs text-white/65">External</span></div>}
                          </td>
                          <td class="px-6 py-4 text-left">{grandchild.status ?? 'ACTIVE'}</td>
                        </tr>
                      )
                    })}
                  </>
                );
              })}
            </>
          ))}
        </tbody>
      </table>
    </div>
  </section>
</Layout>
